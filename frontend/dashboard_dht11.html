<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Agriculture Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-connected {
            background: #10b981;
            color: white;
        }

        .status-disconnected {
            background: #ef4444;
            color: white;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .card-title {
            font-size: 1.2em;
            color: #333;
            font-weight: 600;
        }

        .card-value {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        .card-unit {
            font-size: 0.5em;
            color: #888;
        }

        .card-footer {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        canvas {
            max-width: 100%;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
            margin-top: 50px;
        }

        .error {
            background: #fef2f2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .updating {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåæ IoT Agriculture Dashboard</h1>
            <p>Monitoring DHT11 Sensor Data</p>
            <div class="status-badge" id="connectionStatus">
                ƒêang k·∫øt n·ªëi...
            </div>
        </header>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div class="dashboard">
            <!-- Temperature Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üå°Ô∏è</div>
                    <div class="card-title">Nhi·ªát ƒê·ªô</div>
                </div>
                <div class="card-value" id="temperature">
                    --<span class="card-unit">¬∞C</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Min</div>
                        <div class="stat-value" id="tempMin">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Max</div>
                        <div class="stat-value" id="tempMax">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg</div>
                        <div class="stat-value" id="tempAvg">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Current</div>
                        <div class="stat-value" id="tempCurrent">--</div>
                    </div>
                </div>
                <div class="card-footer" id="tempUpdate">
                    Ch∆∞a c√≥ d·ªØ li·ªáu
                </div>
            </div>

            <!-- Humidity Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üíß</div>
                    <div class="card-title">ƒê·ªô ·∫®m</div>
                </div>
                <div class="card-value" id="humidity">
                    --<span class="card-unit">%</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Min</div>
                        <div class="stat-value" id="humMin">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Max</div>
                        <div class="stat-value" id="humMax">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg</div>
                        <div class="stat-value" id="humAvg">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Current</div>
                        <div class="stat-value" id="humCurrent">--</div>
                    </div>
                </div>
                <div class="card-footer" id="humUpdate">
                    Ch∆∞a c√≥ d·ªØ li·ªáu
                </div>
            </div>

            <!-- Data Points Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìä</div>
                    <div class="card-title">Th·ªëng K√™</div>
                </div>
                <div style="margin: 20px 0;">
                    <div class="stat-item" style="margin-bottom: 10px;">
                        <div class="stat-label">T·ªïng s·ªë ƒëi·ªÉm d·ªØ li·ªáu</div>
                        <div class="stat-value" id="dataPoints">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Thi·∫øt b·ªã</div>
                        <div class="stat-value" id="device">--</div>
                    </div>
                </div>
                <div class="card-footer" id="lastUpdate">
                    C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: --
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <h2 class="chart-title">üìà L·ªãch S·ª≠ D·ªØ Li·ªáu (30 ph√∫t g·∫ßn nh·∫•t)</h2>
            <canvas id="sensorChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_URL = 'http://localhost:3000/api';
        let chart = null;

        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Nhi·ªát ƒë·ªô (¬∞C)',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'ƒê·ªô ·∫©m (%)',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Nhi·ªát ƒë·ªô (¬∞C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ƒê·ªô ·∫©m (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Update Chart
        function updateChart(data) {
            if (!chart) return;

            const labels = data.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleTimeString('vi-VN');
            });

            const temps = data.map(d => d.temperature);
            const hums = data.map(d => d.humidity);

            chart.data.labels = labels;
            chart.data.datasets[0].data = temps;
            chart.data.datasets[1].data = hums;
            chart.update();
        }

        // Fetch latest data
        async function fetchLatestData() {
            try {
                const response = await fetch(`${API_URL}/sensor-data/latest`);
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    
                    // Update cards
                    document.getElementById('temperature').innerHTML = 
                        `${data.temperature}<span class="card-unit">¬∞C</span>`;
                    document.getElementById('humidity').innerHTML = 
                        `${data.humidity}<span class="card-unit">%</span>`;
                    document.getElementById('device').textContent = data.device;

                    const updateTime = new Date(data.timestamp).toLocaleString('vi-VN');
                    document.getElementById('tempUpdate').textContent = updateTime;
                    document.getElementById('humUpdate').textContent = updateTime;
                    document.getElementById('lastUpdate').textContent = `C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${updateTime}`;

                    // Update status
                    updateConnectionStatus(true);
                }
            } catch (error) {
                console.error('Error fetching latest data:', error);
                updateConnectionStatus(false);
            }
        }

        // Fetch statistics
        async function fetchStatistics() {
            try {
                const response = await fetch(`${API_URL}/statistics`);
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;

                    // Temperature stats
                    document.getElementById('tempMin').textContent = stats.temperature.min + '¬∞C';
                    document.getElementById('tempMax').textContent = stats.temperature.max + '¬∞C';
                    document.getElementById('tempAvg').textContent = stats.temperature.avg + '¬∞C';
                    document.getElementById('tempCurrent').textContent = stats.temperature.current + '¬∞C';

                    // Humidity stats
                    document.getElementById('humMin').textContent = stats.humidity.min + '%';
                    document.getElementById('humMax').textContent = stats.humidity.max + '%';
                    document.getElementById('humAvg').textContent = stats.humidity.avg + '%';
                    document.getElementById('humCurrent').textContent = stats.humidity.current + '%';

                    // Data points
                    document.getElementById('dataPoints').textContent = stats.dataPoints;
                }
            } catch (error) {
                console.error('Error fetching statistics:', error);
            }
        }

        // Fetch history data
        async function fetchHistoryData() {
            try {
                const response = await fetch(`${API_URL}/sensor-data?limit=100`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    updateChart(result.data);
                }
            } catch (error) {
                console.error('Error fetching history:', error);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const badge = document.getElementById('connectionStatus');
            if (connected) {
                badge.className = 'status-badge status-connected';
                badge.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi';
            } else {
                badge.className = 'status-badge status-disconnected';
                badge.textContent = '‚ùå M·∫•t k·∫øt n·ªëi';
            }
        }

        // Refresh all data
        function refreshData() {
            fetchLatestData();
            fetchStatistics();
            fetchHistoryData();
        }

        // Initialize
        initChart();
        refreshData();

        // Auto refresh every 5 seconds
        setInterval(refreshData, 5000);
    </script>
</body>
</html>
